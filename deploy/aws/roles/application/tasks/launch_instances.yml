---

- name: Launch EC2 Instance
  ec2:
     instance_type: "{{service_instance_type}}"
     image: "{{service_ami_id}}"
     wait: true
     exact_count: "{{service_count}}"
     count_tag:
        Name: "{{service_instance_name}}"
     instance_tags:
        Name: "{{service_instance_name}}"
        ServiceType: "{{service_type}}"
        Environment: "{{env}}"
        CommitId: "{{commit_id}}"
     group_id: "{{service_security_group_ids}}"
     vpc_subnet_id: "{{vpc_subnet_id}}"
     assign_public_ip: yes
     monitoring: "{{detailed_monitoring}}"
     region: "{{aws_region}}"
     key_name: "{{aws_key_pair}}"
     volumes:
       - device_name: /dev/xvda
         volume_type: gp2
         volume_size: "{{disk_space_size}}"
         delete_on_termination: true
  register: ec2_info

- name: tag instances
  ec2_tag:
    region: "{{aws_region}}"
    resource: "{{ item.id }}"
    tags:
      ServiceType: "{{service_type}}"
      Environment: "{{env}}"
      CommitId: "{{commit_id}}"
  with_items: '{{ec2_info.tagged_instances}}'

- name: Add new instances to host group
  add_host: hostname={{ item.public_ip }} groupname=launched
  with_items: '{{ec2_info.tagged_instances}}'

- name: Wait for instances to listen on port 22
  wait_for: host={{ item.public_dns_name }} port=22 delay=10 timeout=320 state=started
  with_items: '{{ec2_info.tagged_instances}}'
